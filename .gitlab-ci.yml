stages:
  - test
  - security
  - deploy

variables:
  MYSQL_ROOT_PASSWORD: password
  MYSQL_DATABASE: laravel_test
  REDIS_URL: redis://redis:6379

test:
  stage: test
  image: php:8.2-cli
  services:
    - mysql:8.0
    - redis:7
  before_script:
    - apt-get update -yqq
    - apt-get install git unzip libzip-dev zip libpng-dev libonig-dev libxml2-dev -yqq
    - docker-php-ext-install pdo_mysql zip bcmath gd
    - pecl install redis
    - docker-php-ext-enable redis
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --no-progress --no-interaction --prefer-dist
    - cp .env.example .env
    - php artisan config:clear
    - php artisan migrate --force --env=testing
  script:
    - php artisan config:clear --env=testing
    - php artisan test --coverage
  coverage: '/Coverage: \d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

security:
  stage: security
  image: php:8.2-cli
  before_script:
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --no-progress --no-interaction --prefer-dist
  script:
    - php composer.phar audit
    - php composer.phar require --dev enshrined/svg-sanitizer
    - php composer.phar vendor/bin/security-checker security:check

deploy:
  stage: deploy
  image: alpine:latest
  only:
    - main
  script:
    - echo "Deploy to production"
    # Add your deployment commands here