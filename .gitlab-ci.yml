stages:
  - test
  - security
  - deploy

variables:
  MYSQL_ROOT_PASSWORD: password
  MYSQL_DATABASE: laravel_test
  APP_ENV: testing

test:
  stage: test
  image: php:8.2-cli
  services:
    - mysql:8.0
  before_script:
    - apt-get update -yqq
    - apt-get install git unzip libzip-dev zip libpng-dev libonig-dev libxml2-dev -yqq
    - docker-php-ext-install pdo_mysql zip bcmath gd
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --no-progress --no-interaction --prefer-dist
    - cp .env.example .env
    - php artisan config:clear
    - php artisan migrate --force --env=testing
  script:
    - php artisan config:clear --env=testing
    - php artisan test

security:
  stage: security
  image: php:8.2-cli
  before_script:
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install --no-progress --no-interaction --prefer-dist
  script:
    - php composer.phar audit

deploy:
  stage: deploy
  image: alpine:latest
  only:
    - main
  script:
    - echo "Deploy to production"
    # Add your deployment commands here